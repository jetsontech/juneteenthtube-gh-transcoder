name: Video Transcoder

on:
  repository_dispatch:
    types: [transcode]

jobs:
  transcode:
    runs-on: ubuntu-latest
    
    # We allow the job to run up to 360 minutes (GH Actions max)
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm install

      - name: Build TypeScript
        run: npx tsc index.ts --esModuleInterop

      - name: Run Transcoder
        env:
          # Passed from the webhook payload (e.g. { "client_payload": { "videoId": "..." } })
          VIDEO_ID: ${{ github.event.client_payload.videoId }}
          
          # Environment variables mapped from GitHub Repository Secrets
          # noinspection GitHubActionsUnknownSecret
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets['NEXT_PUBLIC_SUPABASE_URL'] }}
          # noinspection GitHubActionsUnknownSecret
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets['SUPABASE_SERVICE_ROLE_KEY'] }}
          # noinspection GitHubActionsUnknownSecret
          S3_ACCESS_KEY_ID: ${{ secrets['R2_ACCESS_KEY_ID'] }}
          # noinspection GitHubActionsUnknownSecret
          S3_SECRET_ACCESS_KEY: ${{ secrets['R2_SECRET_ACCESS_KEY'] }}
          # noinspection GitHubActionsUnknownSecret
          S3_ENDPOINT: ${{ secrets['R2_ENDPOINT'] }}
          # noinspection GitHubActionsUnknownSecret
          S3_BUCKET_NAME: ${{ secrets['R2_BUCKET_NAME'] }}
          S3_REGION: "auto"
          # noinspection GitHubActionsUnknownSecret
          S3_PUBLIC_DOMAIN: ${{ secrets['R2_PUBLIC_DOMAIN'] }}
        run: npm start
